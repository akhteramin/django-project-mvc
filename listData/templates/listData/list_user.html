{% extends "main.html" %}

{% block content %}
{% include "menu_bar.html" %}
{% load datetime %}
<main class="main-content bgc-grey-100">
    <div id="mainContent" class="row bgc-white bd bdrs-3 p-20 mB-20">
        <div class="col-md-12">

            <h1>User List</h1>
            <b> Total Users: {{users.count}} </b>
        </div>
        <div class="col-md-12">
            {% if message and status %}
                {% if status == 201 %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                      <strong>Success!</strong> {{ message }}
                    </div>
                    {% else %}
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                      <strong>Warning!</strong> {{ message }}
                    </div>
                {% endif%}
            {% endif%}
        </div>
        <div>
            <div class="row">
                <div class="col-md-3">
                    {% for permissions in request.session.permissionList %}
                        {% if permissions.serviceID == "AUTH_CREATE_USER" %}
                            <a href="{% url 'createData:create_user' %}" class="btn button-create_indicator active" role="button" aria-pressed="true">Create User</a>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="col-md-5 offset-md-3 search-content">

                    <form class="form-horizontal" name="UserForm" action="{% url 'listData:list_user' %}" method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-4">
                                <input type="text" class="form-control input-sm chat-input"
                                       {% if searchParam.login_id  %}
                                            value={{searchParam.login_id}}
                                        {% endif %}
                                       id="login_id" name="login_id"  placeholder="login id">

                            </div>
                            <div class="col-md-4">
                                <select class="form-control" name="app_id" id="app_id">
                                    <option value="">Select Application</option>
                                {% for application in applications %}
                                    {% if searchParam.app_id|add:"0" == application.id|add:"0" %}
                                        <option value="{{ application.id }}"  selected >{{ application.appName }}</option>
                                    {% else %}
                                        <option value="{{ application.id }}" >{{ application.appName }}</option>

                                    {% endif %}

                                {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="button-search">Search</button>

                                <a href="{% url 'listData:list_user' %}">
                                    <button type="button" class="button-reset">Reset</button>
                                </a>
                            </div>
                        </div>


                    </form>
                </div>
            </div>
            <br/>
            <div id="dataTable_wrapper" class="dataTables_wrapper">
                <table id="dataTable" class="table table-striped table-bordered dataTable" aria-describedby="dataTable_info" role="grid" width="100%">
                      <thead>
                        <tr>
                            <th class="sorting_asc" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1" >Login ID</th>
                            <th class="sorting_asc" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1" >Application Name</th>
                            <th class="sorting_asc" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1" >Device ID</th>
                            <th class="sorting_asc" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1" >Created At</th>
                            <th class="sorting_asc" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1" >Updated At</th>
                            <th class="sorting_asc" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1" >Account Status</th>
                            <th class="sorting_asc" tabindex="0" aria-controls="dataTable" rowspan="1" colspan="1" class="text-center">Action</th>


                        </tr>
                      </thead>
                      <tbody>
                      {% for user in users.results %}
                           <tr>
                               <td>{{user.loginID}}</td>
                               <td>
                                   {% for application in applications %}
                                            {% if user.appID|add:"0" == application.id|add:"0" %}
                                                {{application.appName}}
                                            {% endif %}
                                   {% endfor %}
                               </td>
                               <td>{{user.deviceID}}</td>
                               <td>{{user.createdAT | get_date_time:user.createdAT}}</td>
                               <td>{{user.updatedAT | get_date_time:user.updatedAT}}</td>
                               <td>
                                {% if user.is_active  %}
                                    Active
                                {% else %}
                                   Inactive
                                {% endif %}
                               </td>
                               <td id="actionUser_{{user.id}}" class="text-center">
                                   <!--<a href="#" class="btn btn-info btn-md active" role="button" aria-pressed="true">Edit</a>-->
                                   {% for permissions in request.session.permissionList %}
                                        {% if permissions.serviceID == "AUTH_ACTIVATE_USER" %}
                                            <a href="/edit/user/{{user.id}}" class="btn button-create_indicator" role="button" aria-pressed="true">Assign App</a>
                                           {% endif %}
                                    {% endfor %}
                                   {% for permissions in request.session.permissionList %}
                                        {% if permissions.serviceID == "AUTH_ASSIGN_USER_GROUP" %}
                                            <a href="/assign/user/group/{{user.id}}/{{user.appID}}" class="btn button-assign-service" role="button" aria-pressed="true">Assign Group</a>
                                           {% endif %}
                                    {% endfor %}
                                   {% for permissions in request.session.permissionList %}
                                        {% if permissions.serviceID == "AUTH_SET_PASSWORD" %}
                                            <a href="#" onclick="setData('{{user.loginID}}','{{user.appID}}')" class="btn button-set-password" data-toggle="modal" data-target="#ChangePasswordModal" role="button" aria-pressed="true">Set Password</a>
                                        {% endif %}
                                    {% endfor %}

                                   {% for permissions in request.session.permissionList %}
                                        {% if permissions.serviceID == "AUTH_ACTIVATE_USER" %}
                                           {% if user.is_active  %}
                                           <a id="deactivate_{{user.id}}" href="#" onclick="changeStatus('{{user.loginID}}','{{user.appID}}','0','{{user.id}}')" class="btn button-deactivate">Deactivate</a>
                                           {% else %}
                                           <a id="activate_{{user.id}}" href="#" onclick="changeStatus('{{user.loginID}}','{{user.appID}}','1','{{user.id}}')" class="btn button-activate">Activate</a>
                                           {% endif %}
                                        {% endif %}

                                   {% endfor %}

                               </td>

                           </tr>
                        {% endfor %}
                      </tbody>
                </table>
            </div>

            <nav aria-label="Page navigation example">
              <ul class="pagination justify-content-center">
                  {% if users.previous == None %}
                    <li class="page-item disabled">
                      <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                          Previous
                      </a>
                    </li>
                  {% else %}
                    <li class="page-item">
                    <form class="form-horizontal" action="{% url 'listData:list_user' %}?login_id={{searchParam.login_id}}&app_id={{searchParam.app_id}}" method="post">
                        {% csrf_token %}
                        <input id="prev_url" name="prev_url" type="hidden" value='{{users.previous}}'>


                      <button type="submit" class="page-link"  aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                          Previous
                      </button>
                    </form>
                    </li>
                  {% endif %}
                <!--<li class="page-item"><a class="page-link" href="#">1</a></li>-->
                <!--<li class="page-item"><a class="page-link" href="#">2</a></li>-->
                <!--<li class="page-item"><a class="page-link" href="#">3</a></li>-->
              {% if users.next == None %}
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="Next">
                      Next
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Next</span>

                  </a>
                </li>
              {% else %}
                  <li class="page-item">
                  <form class="form-horizontal" action="{% url 'listData:list_user' %}?login_id={{searchParam.login_id}}&app_id={{searchParam.app_id}}" method="post">
                      {% csrf_token %}


                      <input id="next_url" name="next_url" type="hidden" value='{{users.next}}'>

                      <button type="submit" class="page-link" aria-label="Next">
                          Next
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Next</span>

                      </button>
                  </form>
                </li>
              {% endif %}
              </ul>
            </nav>
        </div>
    </div>

    <div id="ChangePasswordModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
     <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;  </button>
            <h4 class="modal-title" id="myModalLabel">Change Password</h4>
          </div>
            <form class="form-horizontal" name="UserForm" id="postUserForm" method="POST">
                {% csrf_token %}
              <div class="modal-body">
                <div id="loginHeader"></div>
                <br/>
                <div class="control-group">
                    <label class="control-label" for="password">Password (Password length must be more than 8 characters)</label>
                    <div class="controls">


                        <input type="hidden" name="loginID" id="loginID">
                        <input type="hidden" name="appID" id="appID">

                        <input type="password" class="form-control input-sm chat-input" name="password" id="password" placeholder="Password">
                    </div>
                </div>
              </div>
              <div class="modal-footer">
                  <button id="change_pass" type="submit" class="btn btn-primary" disabled="disabled">Save changes</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

              </div>
            </form>
        </div>
      </div>
    </div>
</main>


{% endblock %}